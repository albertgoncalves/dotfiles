#!/usr/bin/env bash

set -eu -o pipefail

bash_shared () {
    echo ". $HOME/.nix-profile/etc/profile.d/nix.sh" >> "$HOME/.bashrc"
    if [ -d "$HOME/miniconda3" ]; then
        echo ". $HOME/miniconda3/etc/profile.d/conda.sh" >> "$HOME/.bashrc"
    fi
}

vim_shared () {
    mkdir -p "$HOME/.vim/colors"
    mkdir -p "$HOME/.vim/syntax"

    f () {
        if [ ! -f "$HOME/.vim/syntax/$2" ]; then
            curl "$GIT_URL/$1" > "$HOME/.vim/syntax/$2"
        fi
    }

    f "futhark-vim/simplify/syntax/fut.vim"                 "fut.vim"
    f "haskell.vim/master/syntax/haskell.vim"               "haskell.vim"
    f "vim-javascript-syntax/master/syntax/javascript.vim"  "javascript.vim"
    f "vim-nix/master/syntax/nix.vim"                       "nix.vim"
    f "stan.vim/master/syntax/stan.vim"                     "stan.vim"
    f "typescript-vim/master/syntax/typescript.vim"         "typescript.vim"
    f "rust.vim/master/syntax/rust.vim"                     "rust.vim"
}

if [ "$(uname -s)" = "Darwin" ]; then
    cp "$WD/bash/profile"       "$HOME/.bash_profile"
    cp "$WD/bash/darwin.bashrc" "$HOME/.bashrc"
    bash_shared
    vim_shared
    cp "$WD/vim/darwin.vimrc"   "$HOME/.vimrc"
    cp "$WD/vim/bla.vim"        "$HOME/.vim/colors/bla.vim"
    if [ ! -d "$HOME/.config/alacritty" ]; then
        mkdir -p "$HOME/.config/alacritty"
    fi
    cp "$WD/alacritty/alacritty.yml"    "$HOME/.config/alacritty/alacritty.yml"
else
    cp "$WD/bash/linux.bashrc"  "$HOME/.bashrc"
    bash_shared
    echo "" | cat "/etc/skel/.bashrc" - "$HOME/.bashrc" > "$WD/tmp.bashrc"
    mv "$WD/tmp.bashrc"         "$HOME/.bashrc"
    vim_shared
    cp "$WD/vim/linux.vimrc"    "$HOME/.vimrc"
    cp "$WD/vim/blx.vim"        "$HOME/.vim/colors/bla.vim"
    cp "$WD/i3/i3.config"       "$HOME/.config/i3/config"
    cp "$WD/i3/i3status.config" "$HOME/.config/i3status/config"
    if [ ! -d "$HOME/bin" ]; then
        mkdir "$HOME/bin"
    fi
    cp "$WD/bin/cbacklight"     "$HOME/bin/cbacklight"
    cp "$WD/i3/fehbg"           "$HOME/.fehbg"
    cp "$WD/i3/redshift"        "$HOME/.redshift"
fi
cp "$WD/tmux/tmux.conf"         "$HOME/.tmux.conf"
if [ ! -f "$HOME/.gitconfig" ]; then
    echo Update "$HOME/.gitconfig" with \`user.name\` and \`user.email\`!
    cp "$WD/git/config"         "$HOME/.gitconfig"
fi
